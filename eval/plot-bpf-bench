#!/usr/bin/Rscript

source("plotlib.R")


DATA <- DATA %>%
  filter(burst_pos > 0) %>%
  group_by(T, workload_exitcode, burst_pos, CPUFREQ, bench_script,
           WORKLOAD) %>%
  mutate(across(where(is.numeric), ~ .x / mean(.x, na.rm = TRUE), .names = "norm_{.col}")) %>%
  ungroup()

summary(DATA)

cns <- colnames(DATA)
metrics <- cns[startsWith(cns, "norm_bpf_bench_")]

for (m in metrics) {
  print(m)
  ggplot(DATA, aes(y=paste(sub("^.+/bench ", "", WORKLOAD)), x=get(m), colour=MERGE_CONFIGS)) +
    geom_boxplot() +
    facet_grid(rows=vars(T, workload_exitcode),
               cols=vars(CPUFREQ, bench_script),
               labeller=label_both, scales="free")
  eval_save(paste0(m, "-point"))
}
