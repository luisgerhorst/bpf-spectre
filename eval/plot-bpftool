#!/usr/bin/Rscript

source("plotlib.R")

DATA <- DATA %>%
  filter(!str_detect(BPF_OBJ, ".*custom_.*"))

cns <- colnames(DATA)
metrics <- cns[cns == "bpftool_loadall_exitcode"]
for (m in metrics) {
  print(m)
  ggplot(DATA, aes(y=paste(BPF_OBJ, " ", bpftool_prog, "()", sep=""), x=get(m), colour=paste(CAPSH_ARGS, MERGE_CONFIGS, net_core_bpf_jit_harden))) +
    geom_boxplot() +
    facet_grid(rows=vars(T),
               cols=vars(CPUFREQ, bench_script),
               labeller=label_both, scales="free")
  eval_save(paste0(m, "-point"))
}

DATA <- DATA %>%
  filter(bpftool_loadall_exitcode == 0)
cns <- colnames(DATA)
metrics <- cns[startsWith(cns, "bpftool_jited_insncnt_") |
               cns == "bpftool_run_exitcode"]
for (m in metrics) {
  print(m)
  ggplot(DATA, aes(y=paste(BPF_OBJ, " ", bpftool_prog, "()", sep=""), x=get(m), colour=paste(CAPSH_ARGS, MERGE_CONFIGS, net_core_bpf_jit_harden))) +
    geom_boxplot() +
    facet_grid(rows=vars(T, bpftool_loadall_exitcode),
               cols=vars(CPUFREQ, bench_script),
               labeller=label_both, scales="free")
  eval_save(paste0(m, "-point"))
}

DATA <- DATA %>%
  filter(bpftool_run_exitcode == 0)
cns <- colnames(DATA)
metrics <- cns[startsWith(cns, "bpftool_run_duration")]
for (m in metrics) {
  print(m)
  ggplot(DATA, aes(y=paste(BPF_OBJ, " ", bpftool_prog, "()", sep=""), x=get(m), colour=paste(CAPSH_ARGS, MERGE_CONFIGS, net_core_bpf_jit_harden))) +
    geom_boxplot() +
    facet_grid(rows=vars(T, bpftool_loadall_exitcode, bpftool_run_exitcode),
               cols=vars(CPUFREQ, bench_script),
               labeller=label_both, scales="free")
  eval_save(paste0(m, "-point"))
}
