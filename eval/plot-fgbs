#!/usr/bin/Rscript

source("plotlib.R")

dura <- DATA %>%
  filter(BPF_OBJ == "lbe_sockfilter.bpf.o"
         | str_detect(BPF_OBJ, "^*init_whole_stack*")
         | str_detect(BPF_OBJ, "^*minimal_legacy"))

summary(dura)
print(dura)

dura <- dura %>%
  filter(bpftool_loadall_exitcode == 0)

dura <- dura %>%
  filter(bpftool_run_exitcode == 0)

ggplot(dura, aes(x=User, y=bpftool_run_duration_ns, colour=SYSCTL)) +
  geom_boxplot() +
  scale_y_continuous(limits = c(0, NA)) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  facet_grid(cols=vars(BPF_OBJ, bpftool_prog),
             scales="free")
eval_save(paste0("duration"),
          title = NULL,
          width_cm = 24,
          height_cm = 14,
          subtitle = NULL)

ed <- DATA %>%
  filter(User == "Privileged", !str_detect(BPF_OBJ, "^*custom_*"))

expr <- ed %>%
  group_by(BPF_OBJ, .drop=F) %>%
  summarize(ble_max = max(bpftool_loadall_exitcode), ble_min = min(bpftool_loadall_exitcode)) %>%
  ungroup() %>%
  filter(ble_min == 0)

expr <- ed %>%
  inner_join(expr)

ggplot(expr, aes(y=BPF_OBJ, x=SYSCTL, fill=factor(bpftool_loadall_exitcode))) +
  geom_raster() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
eval_save(paste0("loading"),
          title = NULL,
          width_cm = 24,
          height_cm = 14,
          subtitle = NULL)
