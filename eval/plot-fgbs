#!/usr/bin/Rscript

source("plotlib.R")

DATA <- DATA %>%
  filter(BPF_OBJ == "lbe_sockfilter.bpf.o"
         | str_detect(BPF_OBJ, "^*init_whole_stack*")
         | str_detect(BPF_OBJ, "^*minimal_legacy"))

summary(DATA)
print(DATA)

cns <- colnames(DATA)
metrics <- cns[cns == "bpftool_loadall_exitcode"]

for (m in metrics) {
  print(m)
  ggplot(DATA, aes(x=paste(BPF_OBJ, " ", bpftool_prog, "()", sep=""), y=get(m), colour=paste(CAPSH_ARGS, SYSCTL))) +
    geom_boxplot() +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    facet_grid(rows=vars(T), labeller=label_both, scales="free")
  eval_save(paste0(m, "-point"))
}

DATA <- DATA %>%
  filter(bpftool_loadall_exitcode == 0)
cns <- colnames(DATA)
metrics <- cns[startsWith(cns, "bpftool_jited_insncnt_") |
               cns == "bpftool_run_exitcode"]
for (m in metrics) {
  print(m)
  ggplot(DATA, aes(x=paste(BPF_OBJ, " ", bpftool_prog, "()", sep=""), y=get(m), colour=paste(CAPSH_ARGS, SYSCTL))) +
    geom_boxplot(position = "dodge") +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    facet_grid(rows=vars(T, bpftool_loadall_exitcode),
               cols=vars(CPUFREQ, bench_script),
               labeller=label_both, scales="free")
  eval_save(paste0(m, "-point"))
}

DATA <- DATA %>%
  filter(bpftool_run_exitcode == 0)
cns <- colnames(DATA)
metrics <- cns[startsWith(cns, "bpftool_run_duration")]
for (m in metrics) {
  print(m)
  ggplot(DATA, aes(x=paste(BPF_OBJ, " ", bpftool_prog, "()", sep=""), y=get(m), colour=paste(CAPSH_ARGS, SYSCTL))) +
    geom_boxplot() +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    facet_grid(rows=vars(T, bpftool_loadall_exitcode, bpftool_run_exitcode),
               cols=vars(CPUFREQ, bench_script),
               labeller=label_both, scales="free")
  eval_save(paste0(m, "-point"))
}
